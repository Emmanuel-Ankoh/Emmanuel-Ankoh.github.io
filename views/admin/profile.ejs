<%- include('../partials/head', { title }) %>
<main id="main" class="container">
  <h1>Profile</h1>
  <% if (settings && settings.updatedAt) { %>
    <p style="margin:-0.25rem 0 1rem 0;color:var(--muted);font-size:.9rem">Last updated <%= new Date(settings.updatedAt).toLocaleString() %></p>
  <% } %>
  <% if (error) { %><div class="alert error"><%= error %></div><% } %>
  <% if (success) { %><div class="alert success"><%= success %></div><% } %>
  <form method="POST" action="/admin/profile" enctype="multipart/form-data" class="contact-form" style="max-width:720px">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:1rem">
      <div>
        <label>Primary CTA Text</label>
        <input name="homeCtaPrimaryText" value="<%= settings && settings.homeCta && settings.homeCta.primaryText || '' %>" />
      </div>
      <div>
        <label>Primary CTA URL</label>
        <input name="homeCtaPrimaryUrl" value="<%= settings && settings.homeCta && settings.homeCta.primaryUrl || '' %>" />
      </div>
      <div>
        <label>Secondary CTA Text</label>
        <input name="homeCtaSecondaryText" value="<%= settings && settings.homeCta && settings.homeCta.secondaryText || '' %>" />
      </div>
      <div>
        <label>Secondary CTA URL</label>
        <input name="homeCtaSecondaryUrl" value="<%= settings && settings.homeCta && settings.homeCta.secondaryUrl || '' %>" />
      </div>
    </div>
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <label>Name</label>
    <input name="name" value="<%= settings && settings.name || '' %>" required />
    <label>Headline</label>
    <input name="headline" value="<%= settings && settings.headline || '' %>" required />
    <label>Summary</label>
    <textarea name="summary" rows="5" required><%= settings && settings.summary || '' %></textarea>
    <label>Mission Statement</label>
    <textarea name="mission" rows="3" placeholder="Short blurb for hero or skills pages"><%= settings && settings.mission || '' %></textarea>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:1rem">
      <div>
        <label>Location</label>
        <input name="location" value="<%= settings && settings.location || '' %>" placeholder="City, Country" />
      </div>
      <div>
        <label>Phone</label>
        <input name="phone" value="<%= settings && settings.phone || '' %>" placeholder="+233..." />
      </div>
    </div>
    <label style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0 1rem 0">
      <input type="checkbox" name="availability" <%= (settings && settings.availability) ? 'checked' : '' %> />
      Open to work
    </label>
    <div class="grid" style="grid-template-columns:120px 1fr;gap:1rem;align-items:center">
      <div>
        <img id="avatar-preview" src="<%= (settings && settings.avatarUrl) || '/images/placeholder.svg' %>" alt="Current avatar" style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:1px solid var(--border)" />
      </div>
      <div>
        <label>Avatar</label>
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
          <input id="avatar-input" type="file" name="avatar" accept="image/*" style="display:none" />
          <button type="button" class="btn" id="choose-avatar">Choose Image</button>
          <span id="avatar-filename" style="color:var(--muted)">No file chosen</span>
          <button type="submit" class="btn" name="do" value="uploadAvatar">Upload Avatar</button>
        </div>
        <small>Max 5MB. JPG/PNG/WebP recommended.</small>
      </div>
    </div>
    <label>Resume URL</label>
    <input name="resumeUrl" value="<%= settings && settings.resumeUrl || '' %>" />
    <label>Contact Intro</label>
    <input name="contactIntro" value="<%= settings && settings.contactIntro || '' %>" />
    <fieldset style="border:1px solid var(--border);padding:1rem;border-radius:.5rem">
      <legend>Social Links</legend>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:1rem">
        <div>
          <label>GitHub</label>
          <input name="socials.github" value="<%= settings && settings.socials && settings.socials.github || '' %>" />
        </div>
        <div>
          <label>LinkedIn</label>
          <input name="socials.linkedin" value="<%= settings && settings.socials && settings.socials.linkedin || '' %>" />
        </div>
        <div>
          <label>Twitter</label>
          <input name="socials.twitter" value="<%= settings && settings.socials && settings.socials.twitter || '' %>" />
        </div>
        <div>
          <label>Instagram</label>
          <input name="socials.instagram" value="<%= settings && settings.socials && settings.socials.instagram || '' %>" />
        </div>
        <div>
          <label>YouTube</label>
          <input name="socials.youtube" value="<%= settings && settings.socials && settings.socials.youtube || '' %>" />
        </div>
        <div>
          <label>Stack Overflow</label>
          <input name="socials.stackoverflow" value="<%= settings && settings.socials && settings.socials.stackoverflow || '' %>" />
        </div>
        <div>
          <label>Email</label>
          <input name="socials.email" value="<%= settings && settings.socials && settings.socials.email || '' %>" />
        </div>
      </div>
    </fieldset>

  <label>About Body</label>
  <div id="about-editor" style="min-height:180px;background:var(--card);border:1px solid var(--border);border-radius:.5rem"></div>
  <textarea name="aboutBody" rows="6" style="display:none"><%= settings && settings.aboutBody || '' %></textarea>
    <fieldset style="border:1px solid var(--border);padding:1rem;border-radius:.5rem;margin-top:1rem">
      <legend>Timeline</legend>
      <small>One item per row. Format: year | title | subtitle | description (or just description).</small>
      <div id="timeline-list" class="repeater" style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem"></div>
      <div>
        <button type="button" class="btn" id="add-timeline-item">Add timeline item</button>
      </div>
      <textarea name="timelineText" style="display:none"><%=(Array.isArray(settings && settings.timeline) ? (settings.timeline.map(function(it){
        var parts=[]; if (it.year) parts.push(it.year); if (it.title) parts.push(it.title); if (it.subtitle) parts.push(it.subtitle); if (it.description) parts.push(it.description);
        return parts.join(' | ');
      }).join('\n')) : '') %></textarea>
    </fieldset>

    <fieldset style="border:1px solid var(--border);padding:1rem;border-radius:.5rem;margin-top:1rem">
      <legend>Skills</legend>
      <small>One skill per row. Format: Name:Level (0-100) or Name (Level%).</small>
      <div id="skills-list" class="repeater" style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem"></div>
      <div>
        <button type="button" class="btn" id="add-skill-item">Add skill</button>
      </div>
      <textarea name="skillsText" style="display:none"><%=(Array.isArray(settings && settings.skills) ? (settings.skills.map(function(s){
        var lvl = (typeof s.level === 'number' ? s.level : '');
        return (s.name || '') + (lvl!=='' ? (':' + lvl) : '');
      }).join('\n')) : '') %></textarea>
    </fieldset>
    <fieldset style="border:1px solid var(--border);padding:1rem;border-radius:.5rem;margin-top:1rem">
      <legend>Skill Categories</legend>
      <small>Group related skills (e.g., Frontend, Backend). Each category can list skills using the same format as above.</small>
      <div id="skill-groups-list" style="display:flex;flex-direction:column;gap:1rem;margin-top:.75rem"></div>
      <div>
        <button type="button" class="btn" id="add-skill-group">Add category</button>
      </div>
  <textarea name="skillGroupsJson" style="display:none"><%- JSON.stringify(Array.isArray(settings && settings.skillGroups) ? settings.skillGroups : []) %></textarea>
    </fieldset>
    <fieldset style="border:1px solid var(--border);padding:1rem;border-radius:.5rem;margin-top:1rem">
      <legend>Testimonials</legend>
      <small>One testimonial per row. Format: Name | Role | Quote | Avatar URL (optional) | Link (optional).</small>
      <div id="testimonials-list" class="repeater" style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem"></div>
      <div>
        <button type="button" class="btn" id="add-testimonial-item">Add testimonial</button>
      </div>
      <textarea name="testimonialsText" style="display:none"><%=(Array.isArray(settings && settings.testimonials) ? (settings.testimonials.map(function(t){
        var parts=[]; if (t.name) parts.push(t.name); if (t.role) parts.push(t.role); if (t.quote) parts.push(t.quote); if (t.avatarUrl) parts.push(t.avatarUrl); if (t.link) parts.push(t.link);
        return parts.join(' | ');
      }).join('\n')) : '') %></textarea>
    </fieldset>
    <fieldset style="border:1px solid var(--border);padding:1rem;border-radius:.5rem;margin-top:1rem">
      <legend>Latest Notes / Blog Feed</legend>
      <small>One entry per row. Format: Title | URL (optional) | Summary | Date (optional â€“ e.g., 2024-04-05).</small>
      <div id="notes-list" class="repeater" style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem"></div>
      <div>
        <button type="button" class="btn" id="add-note-item">Add entry</button>
      </div>
      <textarea name="notesText" style="display:none"><%=(Array.isArray(settings && settings.notes) ? (settings.notes.map(function(n){
        var parts=[]; if (n.title) parts.push(n.title); if (n.url) parts.push(n.url); if (n.summary) parts.push(n.summary); if (n.date) parts.push(n.date);
        return parts.join(' | ');
      }).join('\n')) : '') %></textarea>
    </fieldset>
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
      (function(){
        const form = document.currentScript.closest('form');
        const aboutEditor = document.getElementById('about-editor');
        const aboutTextarea = form.querySelector('textarea[name="aboutBody"]');
        if (aboutEditor && window.Quill) {
          const quill = new Quill(aboutEditor, {
            theme: 'snow',
            modules: { toolbar: [['bold','italic','underline','strike'],[{header:[1,2,3,false]}],[{list:'ordered'},{list:'bullet'}],['blockquote','code-block'],['link'],['clean']] }
          });
          quill.root.innerHTML = aboutTextarea.value || '';
          form.addEventListener('submit', ()=>{ aboutTextarea.value = quill.root.innerHTML; });
        }
      })();
    </script>
    <script>
      (function(){
        const form = document.currentScript.closest('form');
        // Avatar live preview
        const avatarInput = form.querySelector('#avatar-input');
        const avatarImg = form.querySelector('#avatar-preview');
        const chooseBtn = form.querySelector('#choose-avatar');
        const fileName = form.querySelector('#avatar-filename');
        if (chooseBtn && avatarInput) {
          chooseBtn.addEventListener('click', ()=> avatarInput.click());
        }
        if (avatarInput && avatarImg) {
          avatarInput.addEventListener('change', function(){
            const f = this.files && this.files[0];
            if (!f) return;
            if (fileName) fileName.textContent = f.name;
            const reader = new FileReader();
            reader.onload = e => { avatarImg.src = e.target.result; };
            reader.readAsDataURL(f); // data: URL works with current CSP
          });
        }
        // Timeline repeater
        function setupSimpleRepeater(options){
          const { listSelector, hiddenSelector, addSelector, placeholder } = options;
          const list = form.querySelector(listSelector);
          const hidden = form.querySelector(hiddenSelector);
          const addBtn = form.querySelector(addSelector);
          if (!list || !hidden || !addBtn) return null;
          function makeRow(value){
            const row = document.createElement('div');
            row.style.display='flex'; row.style.gap='.5rem';
            const input = document.createElement('input');
            input.type='text'; input.placeholder = placeholder; input.style.flex='1';
            if (value) input.value = value;
            const remove = document.createElement('button'); remove.type='button'; remove.textContent='Remove'; remove.className='btn';
            remove.addEventListener('click', ()=>{ row.remove(); });
            row.appendChild(input); row.appendChild(remove);
            return row;
          }
          function loadFromHidden(){
            list.innerHTML='';
            const lines = (hidden.value || '').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
            if (!lines.length) { list.appendChild(makeRow('')); }
            else { lines.forEach(l=> list.appendChild(makeRow(l))); }
          }
          addBtn.addEventListener('click', ()=> list.appendChild(makeRow('')));
          loadFromHidden();
          return { list, hidden };
        }
        const timelineRepeater = setupSimpleRepeater({
          listSelector: '#timeline-list',
          hiddenSelector: 'textarea[name="timelineText"]',
          addSelector: '#add-timeline-item',
          placeholder: 'year | title | subtitle | description'
        });
        const skillsRepeater = setupSimpleRepeater({
          listSelector: '#skills-list',
          hiddenSelector: 'textarea[name="skillsText"]',
          addSelector: '#add-skill-item',
          placeholder: 'Name:Level or Name (Level%)'
        });
        const testimonialsRepeater = setupSimpleRepeater({
          listSelector: '#testimonials-list',
          hiddenSelector: 'textarea[name="testimonialsText"]',
          addSelector: '#add-testimonial-item',
          placeholder: 'Name | Role | Quote | Avatar URL | Link'
        });
        const notesRepeater = setupSimpleRepeater({
          listSelector: '#notes-list',
          hiddenSelector: 'textarea[name="notesText"]',
          addSelector: '#add-note-item',
          placeholder: 'Title | URL | Summary | Date'
        });
        // Skill groups (category + multiline skills)
        (function(){
          const list = form.querySelector('#skill-groups-list');
          const hidden = form.querySelector('textarea[name="skillGroupsJson"]');
          const addBtn = form.querySelector('#add-skill-group');
          if (!list || !hidden || !addBtn) return;

          function parseSkillLine(line){
            let name = line.trim();
            let level;
            const m = line.match(/^([^:]+):\s*([0-9]{1,3})\s*%?$/);
            if (m) {
              name = m[1].trim();
              level = Math.max(0, Math.min(100, parseInt(m[2], 10)));
            } else {
              const m2 = line.match(/^(.+?)\s*\((\d{1,3})%?\)$/);
              if (m2) {
                name = m2[1].trim();
                level = Math.max(0, Math.min(100, parseInt(m2[2], 10)));
              }
            }
            return { name, level };
          }

          function formatSkills(skills){
            return (Array.isArray(skills) ? skills : [])
              .filter(s => s && s.name)
              .map(s => {
                if (typeof s.level === 'number' && !Number.isNaN(s.level)) {
                  return `${s.name}:${s.level}`;
                }
                return s.name;
              })
              .join('\n');
          }

          function makeGroup(group){
            const wrapper = document.createElement('div');
            wrapper.dataset.skillGroup = 'true';
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.gap = '.5rem';
            wrapper.style.border = '1px solid var(--border)';
            wrapper.style.borderRadius = '.5rem';
            wrapper.style.padding = '.75rem';
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.gap = '.5rem';
            header.style.alignItems = 'center';
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'skill-group-title';
            input.placeholder = 'Category (e.g., Frontend)';
            input.style.flex = '1';
            if (group && group.title) input.value = group.title;
            const remove = document.createElement('button');
            remove.type = 'button';
            remove.textContent = 'Remove';
            remove.className = 'btn';
            remove.addEventListener('click', () => {
              wrapper.remove();
            });
            header.appendChild(input);
            header.appendChild(remove);
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'One skill per line. Name:Level (0-100)';
            textarea.rows = 3;
            textarea.name = 'skill-group-skills';
            textarea.style.resize = 'vertical';
            textarea.value = formatSkills(group && group.skills);
            wrapper.appendChild(header);
            wrapper.appendChild(textarea);
            return wrapper;
          }

          function load(){
            list.innerHTML = '';
            let initial = [];
            try {
              initial = JSON.parse(hidden.value || '[]');
              if (!Array.isArray(initial)) initial = [];
            } catch (e) {
              initial = [];
            }
            if (!initial.length) {
              list.appendChild(makeGroup({ title: '', skills: [] }));
            } else {
              initial.forEach(group => list.appendChild(makeGroup(group)));
            }
          }

          addBtn.addEventListener('click', () => {
            list.appendChild(makeGroup({ title: '', skills: [] }));
          });

          form.addEventListener('submit', () => {
            const groups = Array.from(list.querySelectorAll('[data-skill-group]')).map(el => {
              const title = (el.querySelector('input[name="skill-group-title"]')?.value || '').trim();
              const skillsRaw = (el.querySelector('textarea[name="skill-group-skills"]')?.value || '')
                .split(/\r?\n/)
                .map(l => l.trim())
                .filter(Boolean)
                .map(parseSkillLine)
                .filter(item => item.name);
              return { title, skills: skillsRaw };
            }).filter(group => group.title || group.skills.length);
            hidden.value = JSON.stringify(groups);
          });

          load();
        })();
        // Serialize on submit
        form.addEventListener('submit', ()=>{
          const repeaters = [timelineRepeater, skillsRepeater, testimonialsRepeater, notesRepeater].filter(Boolean);
          repeaters.forEach(({ list, hidden }) => {
            const values = Array.from(list.querySelectorAll('input[type="text"]')).map(i=>i.value.trim()).filter(Boolean);
            hidden.value = values.join('\n');
          });
        });
      })();
    </script>

    
    <div class="toolbar">
      <div>
        <a class="btn" href="<%= (site && site.baseUrl) ? site.baseUrl : '/' %>" target="_blank" rel="noopener">Preview site</a>
      </div>
      <button class="btn btn-primary" type="submit">Save</button>
    </div>
  </form>
</main>
<%- include('../partials/footer') %>
